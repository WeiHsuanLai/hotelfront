import{i as U,u as $,r as v,L as j,c as A,b as s,w as r,bT as E,F as H,bU as L,aJ as Q,o as R,a6 as d,t as f,N as J,d as n,f as z,b5 as G,l as h,h as x,n as S}from"./index-DyrUJ6uX.js";import{a as K,u as W}from"./vee-validate.esm-CmLTrP3I.js";import{c as X,b as Y}from"./index.esm-CM_mT7FP.js";import{V as Z}from"./VContainer-D_YT7N13.js";import{V as y}from"./VCol-CHr01122.js";import{V as ee}from"./VForm-Blo9BCbX.js";import{V as te}from"./VDateInput-DCzzcSR5.js";import"./calendar-pVHj4Z8L.js";import"./VMenu-lhmbuH-5.js";const ae={class:"text-center"},se=d("h1",{class:"text-center text-red"},"已下架",-1),ge={__name:"[id]",props:["_id","category","description","quantity","image","name","price","sell"],setup(q){const{apiAuth:w}=S(),{api:k}=S(),F=L(),D=Q(),u=U(),b=$(),m=v(null),i=K("quantity"),t=v({_id:"",name:"",price:0,description:"",image:"",sell:!0,category:"",date:""}),M=j(()=>new Date().toISOString().split("T")[0]),p=v(0),T=q,B=async o=>{if(o!==null){const a=o[0];p.value=T.quantity;const e=new Date(a);e.setHours(e.getHours()+8);const l=e.toISOString();await C(l),console.log("finaldate",l)}else u({text:"要選範圍",snackbarProps:{color:"red"}})},C=async o=>{var a,e;try{const{data:l}=await w.get("/order/all");console.log("data.result",l.result);const _=l.result.flatMap(g=>g.cart.flatMap(c=>c.date.filter(P=>P===o).map(()=>({quantity:c.quantity}))));_.length>0&&(p.value-=_.reduce((g,{quantity:c})=>g+c,0)),console.log("finalQuantity.value",p.value)}catch(l){console.log(l),u({text:((e=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:e.message)||"發生錯誤",snackbarProps:{color:"red"}})}};(async()=>{var o,a;try{const{data:e}=await k.get("/product/"+F.params.id);t.value._id=e.result._id,t.value.name=e.result.name,t.value.price=e.result.price,t.value.description=e.result.description,t.value.image=e.result.image,t.value.sell=e.result.sell,t.value.category=e.result.category,t.value.date=e.result.date,document.title="購物網 | "+t.value.name}catch(e){console.log(e),u({text:((a=(o=e==null?void 0:e.response)==null?void 0:o.data)==null?void 0:a.message)||"發生錯誤",snackbarProps:{color:"red"}})}})();const I=X({quantity:Y().typeError("數量必填").required("數量必填").min(1,"最少為 1")}),{isSubmitting:V,handleSubmit:N}=W({validationSchema:I,initialValues:{quantity:1}}),O=N(async o=>{if(!b.isLogin){D.push("/login");return}const a=await b.addCart(t.value._id,i.value.value,m.value);u({text:a.text,snackbarProps:{color:a.color}})});return(o,a)=>(R(),A(H,null,[s(Z,null,{default:r(()=>[s(y,{cols:"12"},{default:r(()=>[d("h1",ae,f(t.value.name),1)]),_:1}),s(y,{cols:"12"},{default:r(()=>[s(J,{src:t.value.image,height:"200"},null,8,["src"])]),_:1}),s(y,{cols:"12"},{default:r(()=>[d("p",null,"$"+f(t.value.price),1),d("p",null,f(t.value.description),1),s(ee,{disabled:n(V),onSubmit:z(n(O),["prevent"])},{default:r(()=>[s(G,{type:"number",modelValue:n(i).value.value,"onUpdate:modelValue":a[0]||(a[0]=e=>n(i).value.value=e),modelModifiers:{number:!0},"error-messages":n(i).errorMessage.value},null,8,["modelValue","error-messages"]),s(n(te),{modelValue:m.value,"onUpdate:modelValue":[a[1]||(a[1]=e=>m.value=e),B],label:"訂房日期",multiple:"range",min:M.value,"max-weight":"365"},null,8,["modelValue","min"]),s(h,{type:"submit","prepend-icon":"mdi-cart",loading:n(V)},{default:r(()=>[x("加入購物車")]),_:1},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1}),s(E,{class:"align-center justify-center text-center","model-value":!t.value.sell,persistent:""},{default:r(()=>[se,s(h,{to:"/"},{default:r(()=>[x("回首頁")]),_:1})]),_:1},8,["model-value"])],64))}};export{ge as default};
